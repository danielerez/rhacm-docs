[#tagging-resources]
= Tagging resources 

Tag user-created resources on the restore hub cluster to use the existing hub cluster as a restore cluster. This helps you ensure that you have the same content between the restore hub cluster and the backup hub cluster.

When you use an existing hub cluster for a restore hub cluster configuration, tag any resource that you want to be part of the hub cluster backup with the `velero.io/backup-name: backupName` label annotation. Tagging the resources with the Velero annotation marks them as being generated by an earlier restore.

[#prerequisite-resources]
== Prerequisite 

* Ensure you understand the constraints of using an existing hub cluster as a restore hub cluster with resources you created before the restore operation. See xref:../backup_restore/use_existing_hub_cluster.adoc#using-existing-hub[Using an existing hub cluster as a restore hub cluster].
* On the restore hub cluster, update the `DataProtectionApplication` resource and set the storage location to a new, temporary location. You do not want to create the backup used to tag the restore hub cluster resources in the same storage location with the backup hub cluster. 
* Before you tag the resources, make sure you set the storage location to a different location than the backup hub cluster.

[#tagging-resources-velero]
== Tagging resources with the velero label 

To tag user created resources on the restore hub cluster with the `velero.io/backup-name: backupName` label, on the restore hub cluster complete the following steps: 

. Create a `BackupSchedule` resource to generate a backup that has all these hub cluster resources by using the following YAML:

+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: BackupSchedule
metadata:
 name: schedule-acm-msa
 namespace: open-cluster-management-backup
spec:
 veleroSchedule: 0 */1 * * *
 veleroTtl: 120h
 useManagedServiceAccount: true
 paused: false
----

. Verify that the `BackupSchedule` created the hub cluster backup resources and the resource status is `Completed`.
. Pause the `BackupSchedule` schedule and stop generating backups by setting the property `paused=true` on the `schedule-acm-msa BackupSchedule`.
+
*Note:* You cannot run a restore operation on the hub cluster if the `BackupSchedule` is enabled.
. Run a restore operation by using the following YAML: 

+
[source,yaml]
----
kind: Restore
metadata:
name: restore-acm
namespace: open-cluster-management-backup
spec:
cleanupBeforeRestore: None
veleroManagedClustersBackupName: latest
veleroCredentialsBackupName: latest
veleroResourcesBackupName: latest
excludedResources: # exclude managed cluster resources
 - ManagedCluster
excludedNamespaces: # exclude managed cluster namespaces
  - managed-cls-1
  - managed-cls-2
  - managed-cls-n
----

After you complete these steps, the operator goes over each resource which is part of the hub cluster backup and tags it with the `velero.io/backup-name: backupName` , where `backupName` is the name of the latest backup. 

After tagging the resources, you can use the hub cluster as a restore cluster. You can update the DataProtectionApplication storage location to point to the storage location of the backup hub cluster so you can run a restore operation using the hub cluster backup resources. All the restore hub cluster resources are tagged now with the `velero.io/backup-name label`, so they show as being generated by an earlier restore. Therefore, any restore operation that you run on this hub cluster using the `cleanupBeforeRestore` option set to `CleanupRestored` cleans up the data that is not part of the restored backup.

*Important:*

* Do not use the restore operation with the `cleanupBeforeRestore` option set to `CleanupRestored` if you have managed clusters on this hub cluster created by an earlier restore operation which are not part of the restored backup. Otherwise, they get detached from the hub cluster and managed cluster resources deleted. 
* Having this constraint, you could use an existing hub cluster as a restore hub cluster in the following situations:
** There are no managed clusters on this restore hub cluster. 
** There are managed clusters on the restore hub cluster and you do not expect the restore hub cluster user data to be the same with the one available with the restored backup.
** The names of the managed clusters from the restore hub cluster do not collide with any of the managed cluster names from the backup hub cluster.