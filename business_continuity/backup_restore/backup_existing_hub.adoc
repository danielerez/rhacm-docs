[#backup-existing-hub]
= Using an existing hub as a restore hub 

If you use a restore hub as a cluster with resources that a user created before the restore operation, you must understand the following constraints: 

* The existing managed cluster can be detached during the restore process.
* The restore hub can have more resources than the backup hub.

[#existing-clusters-detached]
== Existing managed clusters can be detached during the restore process

If the hub you plan to use for the restore operation already manages some clusters, expect the following outcomes when you run a restore operation with the `cleanupBeforeRestore` option set to `CleanupRestored`:  

* If an earlier backup created the `ManagedCluster` resources, then they have the `velero.io/backup-name: backupName` label annotation set. Therefore, if the user runs a restore operation and uses the `cleanupBeforeRestore=CleanupRestored` option, then these `ManagedCluster` resources are not part of the restored backup. The clusters are detached and the data is cleaned up on those managed clusters. 
* When the  `velero.io/backup-name: backupName` label annotation exists, the managed clusters were created by an earlier backup and are no longer part of the restored backup. As a result, the managed clusters are detached, and the data is cleaned up on those managed clusters if the user runs a restore operation and uses the `cleanupBeforeRestore=CleanupRestored` option .
* If the `ManagedCluster` resource does not have the `velero.io/backup-name: backupName` label annotation, these managed clusters continue to be managed by this hub, even though these clusters were not managed by the backup hub. Therefore, this hub does not match the content of the backup hub. 

[#restore-hub-resources]
== Restore hub can have more resources than the backup hub

If your restore operation uses a hub with earlier created user data, then the restore operation results in a hub that does not have the exact content as the primary hub. The user data includes the following properties: `policy`, `application`, `credential`, or any custom resource defined by the user. A restore operation with the `cleanupBeforeRestore` option set to `CleanupRestored` is not going to clean up these resources because they were created by the users and not created by an earlier backup. 

If you intend to use an existing hub for a restore hub configuration and expect that the hub has the same content as the backup after the restore is completed, tag any resource that would be part of a hub backup with the `velero.io/backup-name: backupName` label annotation. Tagging the resources with the Velero annotation marks them as being generated by an earlier restore.

[#prerequisite-resources]
=== Prerequisite 

* Update the `DataProtectionApplication` resource and set the storage location to a new, temporary location. You do not want to have this backup in the same location with the backup hub, so make sure you set the storage location to a different location.

[#tagging-resources]
=== Tagging resources 

To tag resources with the `velero.io/backup-name: backupName` label, complete the following steps: 

.  Create a `BackupSchedule` resource to generate a backup that contains all these hub resources by using the following yaml:

+
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: BackupSchedule
metadata:
 name: schedule-acm-msa
 namespace: open-cluster-management-backup
spec:
 veleroSchedule: 0 */1 * * *
 veleroTtl: 120h
 useManagedServiceAccount: true
 paused: false
----

. Pause the `BackupSchedule` schedule and stop generating backups by setting the property `paused=true` on the `schedule-acm-msa BackupSchedule`.
.. *Note:* You cannot run a restore operation on the hub cluster if the `BackupSchedule` is enabled, so you pause the `BackupSchedule` to run a restore operation.
. Run a restore operation by using the following yaml: 

+
[source,yaml]
----
kind: Restore
metadata:
name: restore-acm
namespace: open-cluster-management-backup
spec:
cleanupBeforeRestore: None
veleroManagedClustersBackupName: latest
veleroCredentialsBackupName: latest
veleroResourcesBackupName: latest
excludedResources: # exclude managed cluster resources
 - ManagedCluster
excludedNamespaces: # exclude managed cluster namespaces
  - managed-cls-1
  - managed-cls-2
  - managed-cls-n
----

After you complete these steps, the operator goes over each resource which is part of the hub backup and tags it with the `velero.io/backup-name: backupName` , where `backupName` is the name of the latest backup. 

[#understanding-resources]
=== Understanding the resources

You can now use the hub as a restore cluster and update the `DataProtectionApplication` storage location to point to the storage location of the backup hub. Any restore operation that you set the `cleanupBeforeRestore` option to `CleanupRestored` cleans up data that is not part of the latest restored backup. All the hub backup resources are tagged with the `velero.io/backup-name` label, so they show as being generated by an earlier restore.

*Important:*

* If your hub already manages other clusters, they get detached. If you run any restore operation where you use the `cleanupBeforeRestore` set to `CleanupRestored` and if these clusters are not part of the restored backup and they are tagged with the `velero.io/backup-name` label, then the managed cluster resources get removed. Therefore, use the restore resource to exclude any managed cluster resources so that you do not need to tag them with the `velero.io/backup-name` label.
* Do not run a restore operation where you use the `cleanupBeforeRestore` set to `CleanupRestored`. If the restore hub already has managed clusters, and if they were created by an earlier backup, they are tagged with the `velero.io/backup-name` label. If you use this option, the managed clusters get detached and data on the managed clusters get cleaned up. 
* Having this constraint, you could use an existing hub for a restore operation in the following situations: 
** There are no managed clusters on this restore hub. 
** There are managed clusters on the restore hub and you do not expect the restore hub user data to be the same with the one available with the restored backup.
** The names of the managed clusters from the restore hub do not collide with any of the managed cluster names from the backup hub.
* Do not use the restore operation with the `cleanupBeforeRestore` option set to `CleanupRestored` if you have managed clusters on this hub created by an earlier restore operation which are not part of the restored backup. Otherwise, they get detached from the hub and managed cluster resources deleted. 


